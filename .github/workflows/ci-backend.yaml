name: Backend CI Build & Push

on:
  push:
    branches: [ "dev/yhj", "feat/yhj" ]
  pull_request:

env:
  AWS_REGION: ap-northeast-2
  REGISTRY: 911723818289.dkr.ecr.ap-northeast-2.amazonaws.com
  IMAGE_CORE: ddcn41/pjy/main
  IMAGE_ADMIN: ddcn41/pjy/admin
  IMAGE_QUEUE: ddcn41/pjy/queue

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write

    steps:
      # ---------------------------
      # BACKEND REPO CHECKOUT
      # ---------------------------
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Build
        run: ./gradlew build -x test

      # ---------------------------
      # AWS LOGIN / OIDC
      # ---------------------------
      - name: Configure AWS credentials via OIDC
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::911723818289:role/backend-v3-github-actions
          aws-region: ap-northeast-2

      - name: Login to ECR
        uses: aws-actions/amazon-ecr-login@v2

      # ---------------------------
      # SHORT SHA
      # ---------------------------
      - name: Extract short commit SHA
        id: vars
        run: echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_ENV

      # ---------------------------
      # DOCKER IMAGE BUILD & PUSH
      # ---------------------------
      - name: Build Docker images
        run: |
          docker build -t $REGISTRY/$IMAGE_CORE:${{ env.sha_short }} -f module-api/Dockerfile .
          docker build -t $REGISTRY/$IMAGE_ADMIN:${{ env.sha_short }} -f module-api-admin/Dockerfile .
          docker build -t $REGISTRY/$IMAGE_QUEUE:${{ env.sha_short }} -f module-queue/Dockerfile .

      - name: Push Docker images
        run: |
          docker push $REGISTRY/$IMAGE_CORE:${{ env.sha_short }}
          docker push $REGISTRY/$IMAGE_ADMIN:${{ env.sha_short }}
          docker push $REGISTRY/$IMAGE_QUEUE:${{ env.sha_short }}

      # ==================================================================
      # UPDATE MANIFEST REPO (kbsp-jy 브랜치)
      # ==================================================================
      - name: Clone Manifest Repo
        run: |
          git clone --branch kbsp/argocd https://github.com/ddcn4-1/terraform-v3.git manifest
          cd manifest
          git config user.email "action@github.com"
          git config user.name "GitHub Actions"

      # ---------------------------
      # UPDATE core-api IMAGE TAG
      # ---------------------------
      - name: Update core-api image tag
        run: |
          sed -i "s|image: .*core-api:.*|image: $REGISTRY/$IMAGE_CORE:${{ env.sha_short }}|" \
            manifest/kubespray/jy/k8s/aws-kubernetes-cluster/ticket-app/main/deployment.yaml

      # ---------------------------
      # UPDATE admin-api IMAGE TAG
      # ---------------------------
      - name: Update admin-api image tag
        run: |
          sed -i "s|image: .*admin-api:.*|image: $REGISTRY/$IMAGE_ADMIN:${{ env.sha_short }}|" \
            manifest/kubespray/jy/k8s/aws-kubernetes-cluster/ticket-app/admin/deployment.yaml

      # ---------------------------
      # UPDATE queue-api IMAGE TAG
      # ---------------------------
      - name: Update queue-api image tag
        run: |
          sed -i "s|image: .*queue:.*|image: $REGISTRY/$IMAGE_QUEUE:${{ env.sha_short }}|" \
            manifest/kubespray/jy/k8s/aws-kubernetes-cluster/ticket-app/queue/deployment.yaml

      # ---------------------------
      # COMMIT & PUSH
      # ---------------------------
      - name: Commit & Push Manifest Repo
        run: |
          cd manifest
          git add .
          git commit -m "Update image tags to ${{ env.sha_short }}"
          git push origin kbsp/argocd