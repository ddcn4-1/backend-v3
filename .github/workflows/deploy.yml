name: deploy.yml
on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'í…ŒìŠ¤íŠ¸ìš© ê°•ì œ ë°°í¬'
        required: false
        default: false
        type: boolean

env:
  AWS_REGION: ap-northeast-2
  ECR_REGISTRY: ${{ secrets.ECR_REGISTRY }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}

jobs:
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest

    steps:
      - name: code_checkout
        uses: actions/checkout@v4

      - name: JDK_21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'corretto'

      - name: Gradle Cache
        uses: actions/cache@v3
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties') }}

      - name: application_build
        run: |
          chmod +x ./gradlew
          ./gradlew clean build -x test
          echo "ë¹Œë“œ ì™„ë£Œ"

      - name: AWS Authentication
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: ECR login
        uses: aws-actions/amazon-ecr-login@v2

      - name: Docker Image Build and Push
        id: build-image
        run: |
          # ê³ ìœ í•œ ì´ë¯¸ì§€ íƒœê·¸ ìƒì„±
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          SHORT_SHA=${GITHUB_SHA::8}
          IMAGE_TAG="v${TIMESTAMP}-${SHORT_SHA}"
          IMAGE_URI="${ECR_REGISTRY}/${ECR_REPOSITORY}:${IMAGE_TAG}"
          
          echo "ì´ë¯¸ì§€ íƒœê·¸: $IMAGE_TAG"
          
          # Docker ë¹Œë“œ
          echo "Docker ì´ë¯¸ì§€ ë¹Œë“œ ì¤‘..."
          docker build -t $IMAGE_URI .
          
          # ECRì— í‘¸ì‹œ
          echo "ECRì— í‘¸ì‹œ ì¤‘..."
          docker push $IMAGE_URI
          
          # ì¶œë ¥ ë³€ìˆ˜ ì„¤ì •
          echo "image-tag=$IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image-uri=$IMAGE_URI" >> $GITHUB_OUTPUT
          
          echo "ì´ë¯¸ì§€ í‘¸ì‹œ ì™„ë£Œ: $IMAGE_TAG"
          
          

#      - name: Launch Template Update
#        id: update-template
#        run: |
#          echo "Launch Template ìƒˆ ë²„ì „ ìƒì„± ì¤‘..."
#
#          # User Data ìŠ¤í¬ë¦½íŠ¸ ìƒì„± (í•œêµ­ì–´ ì£¼ì„ í¬í•¨)
#          cat > user-data.sh << 'EOF'
#          #!/bin/bash
#
#          set -x
#
#          exec > /var/log/user-data.log 2>&1
#          echo "=== GitHub Actions ìë™ ë°°í¬ ì‹œì‘: $(date) ==="
#
#          # ë°°í¬ ì •ë³´ ì¶œë ¥
#          echo "ì´ë¯¸ì§€ íƒœê·¸: ${{ steps.build-image.outputs.image-tag }}"
#          echo "ë°°í¬ì: ${{ github.actor }}"
#          echo "ì»¤ë°‹: ${{ github.sha }}"
#          echo "ë°°í¬ ì‹œê°„: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
#
#          # ì¸ìŠ¤í„´ìŠ¤ ì •ë³´
#          TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
#          INSTANCE_ID=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/instance-id)
#          INSTANCE_IP=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" -s http://169.254.169.254/latest/meta-data/local-ipv4)
#          echo "ğŸ–¥ï¸ ì¸ìŠ¤í„´ìŠ¤: $INSTANCE_ID ($INSTANCE_IP)"
#
#          # 1ë‹¨ê³„: ì‹œìŠ¤í…œ ì¤€ë¹„
#          echo "ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸ ë° íŒ¨í‚¤ì§€ ì„¤ì¹˜..."
#          yum update -y
#          yum install -y docker aws-cli jq curl htop --allowerasing
#
#          # 2ë‹¨ê³„: Docker ì„¤ì •
#          echo "Docker ì„œë¹„ìŠ¤ ì‹œì‘..."
#          systemctl start docker
#          systemctl enable docker
#          usermod -a -G docker ec2-user
#
#          # 3ë‹¨ê³„: ECR ë¡œê·¸ì¸
#          echo "ECR ë¡œê·¸ì¸..."
#          for i in {1..3}; do
#            if aws ecr get-login-password --region ap-northeast-2 | \
#               docker login --username AWS --password-stdin ${{ env.ECR_REGISTRY }}; then
#              echo "ECR ë¡œê·¸ì¸ ì„±ê³µ"
#              break
#            else
#              echo "ECR ë¡œê·¸ì¸ ì‹¤íŒ¨, ì¬ì‹œë„ ì¤‘... ($i/3)"
#              sleep 10
#            fi
#          done
#
#          # 4ë‹¨ê³„: í™˜ê²½ë³€ìˆ˜ ì„¤ì •
#          echo "ì• í”Œë¦¬ì¼€ì´ì…˜ í™˜ê²½ë³€ìˆ˜ ì„¤ì •..."
#          cat > /home/ec2-user/.env << 'ENVEOF'
#          # ì• í”Œë¦¬ì¼€ì´ì…˜ ì„¤ì •
#          SPRING_PROFILES_ACTIVE=${{secrets.SPRING_PROFILES_ACTIVE}}
#
#          #ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •
#          DATABASE_URL=jdbc:postgresql://${{ secrets.REDIS_HOST }}:5432/${{ secrets.DB_NAME }}
#          DATABASE_USERNAME=${{ secrets.DATABASE_USERNAME }}
#          DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
#
#          #Redis ì„¤ì •
#          REDIS_HOST=${{ secrets.REDIS_HOST }}
#          REDIS_PORT=6379
#
#          #AWS ì„¤ì •
#          AWS_LAMBDA_ASG_SCALER_FUNCTION_NAME=${{ secrets.AWS_LAMBDA_ASG_SCALER_FUNCTION_NAME }}
#          AWS_REGION=${{secrets.AWS_REGION}}
#          AWS_S3_ACCESS_KEY=${{secrets.AWS_S3_ACCESS_KEY}}
#          AWS_S3_SECRET_KEY=${{secrets.AWS_S3_SECRET_KEY}}
#
#
#          # ë°°í¬ ì •ë³´
#          SERVER_IDENTIFIER=GITHUB-ACTIONS
#          SERVER_IP=$INSTANCE_IP
#          DEPLOYMENT_TAG=${{ steps.build-image.outputs.image-tag }}
#          GITHUB_SHA=${{ github.sha }}
#          GITHUB_ACTOR=${{ github.actor }}
#          GITHUB_REPOSITORY=${{ github.repository }}
#          DEPLOY_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
#          ENVEOF
#
#          # íŒŒì¼ ê¶Œí•œ ì„¤ì •
#          chown ec2-user:ec2-user /home/ec2-user/.env
#          chmod 600 /home/ec2-user/.env
#
#          # 5ë‹¨ê³„: ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬
#          echo "ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì •ë¦¬..."
#          docker stop ddcn41-backend-prod 2>/dev/null || echo "ê¸°ì¡´ ì»¨í…Œì´ë„ˆ ì—†ìŒ"
#          docker rm ddcn41-backend-prod 2>/dev/null || echo "ì‚­ì œí•  ì»¨í…Œì´ë„ˆ ì—†ìŒ"
#
#          # 6ë‹¨ê³„: ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
#          echo "ìƒˆ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ..."
#          docker pull ${{ steps.build-image.outputs.image-uri }}
#
#          # 7ë‹¨ê³„: ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘
#          echo "ìƒˆ ì»¨í…Œì´ë„ˆ ì‹œì‘..."
#          docker run -d \
#            --name ddcn41-backend-prod \
#            -p 8080:8080 \
#            --env-file /home/ec2-user/.env \
#            --restart unless-stopped \
#            --health-start-period=60s \
#            --log-opt max-size=50m \
#            --health-cmd="curl -f http://localhost:8080/actuator/health || exit 1" \
#            ${{ steps.build-image.outputs.image-uri }}
#
#          # 8ë‹¨ê³„: ì»¨í…Œì´ë„ˆ ì‹œì‘ í™•ì¸
#          echo "ì»¨í…Œì´ë„ˆ ì‹œì‘ í™•ì¸..."
#          sleep 200
#          if docker ps | grep ddcn41-backend-prod; then
#            echo "ì»¨í…Œì´ë„ˆ ì •ìƒ ì‹œì‘"
#            docker logs ddcn41-backend-prod --tail 10
#          else
#            echo "ì»¨í…Œì´ë„ˆ ì‹œì‘ ì‹¤íŒ¨"
#            docker logs ddcn41-backend-prod
#            exit 1
#          fi
#
#          # 9ë‹¨ê³„: ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬
#          echo "ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬..."
#          HEALTH_CHECK_COUNT=0
#          MAX_ATTEMPTS=20
#
#          while [ $HEALTH_CHECK_COUNT -lt $MAX_ATTEMPTS ]; do
#            sleep 10
#            ((HEALTH_CHECK_COUNT++))
#
#            echo "í—¬ìŠ¤ì²´í¬ ì‹œë„ $HEALTH_CHECK_COUNT/$MAX_ATTEMPTS..."
#
#            if curl -f -s http://localhost:8080/actuator/health > /tmp/health.json; then
#              HEALTH_STATUS=$(cat /tmp/health.json | jq -r '.status // "UNKNOWN"')
#
#              if [ "$HEALTH_STATUS" = "UP" ]; then
#                echo "ì• í”Œë¦¬ì¼€ì´ì…˜ í—¬ìŠ¤ì²´í¬ ì„±ê³µ"
#                echo "í—¬ìŠ¤ ìƒíƒœ:"
#                cat /tmp/health.json | jq '.'
#                break
#              else
#                echo "í—¬ìŠ¤ ìƒíƒœ: $HEALTH_STATUS"
#              fi
#            else
#              echo "ì• í”Œë¦¬ì¼€ì´ì…˜ ì¤€ë¹„ ì¤‘..."
#            fi
#
#            if [ $HEALTH_CHECK_COUNT -eq $MAX_ATTEMPTS ]; then
#              echo "í—¬ìŠ¤ì²´í¬ ìµœì¢… ì‹¤íŒ¨"
#              echo "ì»¨í…Œì´ë„ˆ ë¡œê·¸:"
#              docker logs ddcn41-backend-prod --tail 30
#              exit 1
#            fi
#          done
#
#          # 10ë‹¨ê³„: ìµœì¢… ê²€ì¦
#          echo "ìµœì¢… ê²€ì¦..."
#
#          # Docker ìƒíƒœ í™•ì¸
#          echo "Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ:"
#          docker ps --filter name=ddcn41-backend-prod --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
#
#          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
#          echo "ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤:"
#          free -h
#          df -h /
#
#          echo "=== GitHub Actions ìë™ ë°°í¬ ì™„ë£Œ: $(date) ==="
#          EOF
#
#          # User Data Base64 ì¸ì½”ë”©
#          USER_DATA_BASE64=$(base64 -w 0 user-data.sh)
#
#          # Launch Template ìƒˆ ë²„ì „ ìƒì„±
#          echo "Launch Template ìƒˆ ë²„ì „ ìƒì„±..."
#          NEW_VERSION=$(aws ec2 create-launch-template-version \
#            --launch-template-name ${{ secrets.LAUNCH_TEMPLATE_NAME }} \
#            --source-version '$Latest' \
#            --launch-template-data "{
#              \"UserData\": \"$USER_DATA_BASE64\",
#              \"TagSpecifications\": [{
#                \"ResourceType\": \"instance\",
#                \"Tags\": [
#                  {\"Key\": \"Name\", \"Value\": \"ddcn41-backend-asg\"},
#                  {\"Key\": \"ImageTag\", \"Value\": \"${{ steps.build-image.outputs.image-tag }}\"},
#                  {\"Key\": \"GitCommit\", \"Value\": \"${{ github.sha }}\"},
#                  {\"Key\": \"GitActor\", \"Value\": \"${{ github.actor }}\"},
#                  {\"Key\": \"DeployTime\", \"Value\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\"},
#                  {\"Key\": \"DeployMethod\", \"Value\": \"GitHub-Actions\"},
#                  {\"Key\": \"Repository\", \"Value\": \"${{ github.repository }}\"}
#                ]
#              }]
#            }" \
#            --query 'LaunchTemplateVersion.VersionNumber' \
#            --output text)
#
#          echo "template-version=$NEW_VERSION" >> $GITHUB_OUTPUT
#          echo "Launch Template ë²„ì „ $NEW_VERSION ìƒì„± ì™„ë£Œ"
#
#      - name: ê¸°ì¡´ instance refresh ê°ì§€
#        run: |
#          # ê¸°ì¡´ ì§„í–‰ ì¤‘ì¸ Instance Refreshê°€ ìˆëŠ”ì§€ í™•ì¸
#          EXISTING_REFRESH=$(aws autoscaling describe-instance-refreshes \
#            --auto-scaling-group-name ${{ secrets.ASG_NAME }} \
#            --query 'InstanceRefreshes[?Status==`InProgress`].[InstanceRefreshId]' \
#            --output text)
#
#          if [ -n "$EXISTING_REFRESH" ]; then
#            echo "ì§„í–‰ ì¤‘ì¸ Instance Refresh ë°œê²¬: $EXISTING_REFRESH"
#
#            # force_deployê°€ trueì¸ ê²½ìš° ê°•ì œ ì·¨ì†Œ
#            if [ "${{ github.event.inputs.force_deploy }}" = "true" ]; then
#              echo "force_deploy=true: ì§„í–‰ ì¤‘ì¸ Refresh ê°•ì œ ì·¨ì†Œ ì‹œë„"
#              aws autoscaling cancel-instance-refresh \
#                --auto-scaling-group-name ${{ secrets.ASG_NAME }}
#              echo "ê¸°ì¡´ Instance Refresh ì·¨ì†Œë¨"
#              sleep 10
#            else
#              echo "ì§„í–‰ ì¤‘ì¸ Instance Refreshê°€ ìˆì–´ ë°°í¬ ì¤‘ë‹¨"
#              echo "ìˆ˜ë™ìœ¼ë¡œ ì½˜ì†”ì—ì„œ ì™„ë£Œë˜ê±°ë‚˜, force_deploy=trueë¡œ ì¬ì‹œë„í•˜ì„¸ìš”"
#              exit 1
#            fi
#          fi
#
#
#      - name: ì¤‘ë‹¨ ë°°í¬ ì‹œì‘
#        id: rolling-deploy
#        run: |
#          set -eo pipefail
#          echo "ì¤‘ë‹¨ ë°°í¬ ì‹œì‘..."
#          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
#
#          # ë°°í¬ ì „ ìƒíƒœ í™•ì¸
#          echo "ë°°í¬ ì „ ASG ìƒíƒœ:"
#          aws autoscaling describe-auto-scaling-groups \
#          --auto-scaling-group-names ${{ secrets.ASG_NAME }} \
#          --query 'AutoScalingGroups[0].{DesiredCapacity:DesiredCapacity,Instances:Instances[].{Id:InstanceId,State:LifecycleState,Health:HealthStatus}}'
#
#          # Instance Refresh ì‹œì‘
#          echo "Instance Refresh ì‹œì‘..."
#          REFRESH_ID=$(aws autoscaling start-instance-refresh \
#          --auto-scaling-group-name ${{ secrets.ASG_NAME }} \
#          --preferences '{
#           "InstanceWarmup": 300,
#           "MinHealthyPercentage": 50,
#           "MaxHealthyPercentage": 100,
#           "CheckpointPercentages": [100],
#           "CheckpointDelay": 300,
#           "ScaleInProtectedInstances": "Ignore"
#          }' \
#          --query 'InstanceRefreshId' \
#          --output text)
#
#          echo "Instance Refresh ID: $REFRESH_ID"
#          echo "refresh-id=$REFRESH_ID" >> $GITHUB_OUTPUT
#          echo "deployment-status=STARTED" >> $GITHUB_OUTPUT
#
#          echo "Instance Refreshê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì§„í–‰ë©ë‹ˆë‹¤."
#          echo "AWS ì½˜ì†”ì—ì„œ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”: $REFRESH_ID"
#
#      - name: ë°°í¬ ê²°ê³¼ ì²˜ë¦¬
#        run: |
#          echo "Instance Refresh ì‹œì‘ ì™„ë£Œ"
#          echo "Refresh ID: ${{ steps.rolling-deploy.outputs.refresh-id }}"
#          echo "AWS Auto Scaling ì½˜ì†”ì—ì„œ ì§„í–‰ ìƒí™©ì„ ëª¨ë‹ˆí„°ë§í•˜ì„¸ìš”."

      - name: ë°°í¬ ì„±ê³µ ì•Œë¦¼
        if: success()
        run: |
          echo ""
          echo "         ddcn41 Backend ë°°í¬ ì‹œì‘ ì™„ë£Œ"
          echo ""
          echo "ë°°í¬ ìš”ì•½:"
          echo "  ì´ë¯¸ì§€ íƒœê·¸: ${{ steps.build-image.outputs.image-tag }}"
          echo "  Refresh ID: ${{ steps.rolling-deploy.outputs.refresh-id }}"
          echo "  ë°°í¬ì: ${{ github.actor }}"
          echo "  ë°°í¬ ì‹œì‘ ì‹œê°„: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "  ì»¤ë°‹: https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          echo ""
          echo "Instance Refreshê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤."
          echo "AWS ì½˜ì†”ì—ì„œ ì§„í–‰ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”."

      - name: ë°°í¬ ì‹¤íŒ¨ ì²˜ë¦¬
        if: failure()
        run: |
          echo ""
          echo "         ddcn41 Backend ë°°í¬ ì‹œì‘ ì‹¤íŒ¨"
          echo ""
          echo "ì‹¤íŒ¨ ì •ë³´:"
          echo "ì‹œë„ì: ${{ github.actor }}"
          echo "ì‹œë„ ì‹œê°„: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
          echo "ì»¤ë°‹: https://github.com/${{ github.repository }}/commit/${{ github.sha }}"
          echo ""
          
          # ASG ìƒíƒœ í™•ì¸
          echo "í˜„ì¬ ASG ìƒíƒœ:"
          aws autoscaling describe-auto-scaling-groups \
            --auto-scaling-group-names ${{ secrets.ASG_NAME }} \
            --query 'AutoScalingGroups[0].{DesiredCapacity:DesiredCapacity,Instances:Instances[].{Id:InstanceId,State:LifecycleState,Health:HealthStatus}}' || echo "ASG ìƒíƒœ ì¡°íšŒ ì‹¤íŒ¨"